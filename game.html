<!DOCTYPE html>
<html>
  <head>
    <title>Greed</title>
    <link href="./css/dice.css" rel="stylesheet">
    <style>
      h1 {
        text-align: center;
      }
      .player-name {
        text-align: center;
      }
      .dice-container {
        width: 372px;
        margin: 0 auto;
        font-size: 0;
      }
      .dice {
        display: inline-block;
        width: 150px;
        font-size: 16px;
        text-align: center;
        height: 60px;
        vertical-align: middle;
        line-height: 60px;
        margin-left: 30px;
      }
      .totals {
        width: 900px;
        position: relative;
        left: 0;
        right: 0;
      }
      .total {
        position: absolute;
        left: 0;
      }
      .running-total {
        position: absolute;
        right: 0;
      }
      .buttons {
        margin-top: 40px;
        text-align: center;
      }
      table {
        text-align: center;
        margin: 0 auto;
      }
      table th {
        padding: 0 30px;
      }
      .message {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>Greed</h1>

    <div class="template-container"></div>

<script id="game-template" type="text/x-handlebars-template">
  <div class="player-name">{{playerName}}</div>

  <div class="dice-container">
    <div id="dice0" class="dice class1"></div>
    <div id="dice1" class="dice class1"></div>
    <div id="dice2" class="dice class1"></div>
    <div id="dice3" class="dice class1"></div>
    <div id="dice4" class="dice class1"></div>
    <div id="dice5" class="dice class1"></div>
  </div>

  <div>Winning combos: <span class="win"></span></div>
  <div>Winning scores: <span class="score"></span></div>
  <div>Roll Score: <span class="rollScore"></span></div>
  <div>Total Score: <span class="totalTurnScore">0</span></div>

  <div class="message"></div>

  <div class="totals">
    <span class="total">{{total}}</span>
    <span class="running-total">{{runningTotal}}</span>
  </div>

  <div class="buttons">
    <button class="roll" {{disabled}}>Roll</button>
    <button class="endGo" {{disabled}}>End Go</button>
    <button class="restartGame" {{disabled}}>Restart Game</button>
  </div>

  <table class="score-table">
    <thead>
      {{{thead}}}
    </thead>
    <tr>
      {{{trRound1}}}
    </tr>
    <tr>
      {{{trTotal}}}
    </tr>
  </table>
</script>
<script id="registering-template" type="text/x-handlebars-template">
  <div class='container'>
    <div class='registering'>Game registering</div>

    <div class="inputs">
      <label for="name">Name: </label>
      <input type="text" id="name">
    </div>

    <div class="button-wrapper">
      <button class='join'>Join Game</button>
    </div>
  </div>
</script>
<script id="create-game-template" type="text/x-handlebars-template">
  <div class='container'>
    <div class='create-game'>Create Game</div>

    <div class="inputs">
      <label for="players">Number of Players: </label>
      <input type="text" id="players">
    </div>

    <div class="button-wrapper">
      <button class='create-button'>Create new game</button>
    </div>
  </div>
</script>
<script id="message-template" type="text/x-handlebars-template">
  <div class='container'>
    <div class='in-progress'>{{message}}</div>
  </div>
</script>

<script src="/lib/jquery.js"></script>
<script src="/lib/handlebars-v4.0.5.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/clientjs/animate.js"></script>
<script>
  var name;
  var playerNumber = 1;

  function createGuid() {
    'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = crypto.getRandomValues(new Uint8Array(1))[0]%16|0, v = c == 'x' ? r : (r&0x3|0x8);
      return v.toString(16);
    });
  }

  var socket = io.connect("/",{
    "connect timeout": 3000,
    "reconnect": false
  });

  socket.emit("getStatus");

  socket.on("statusUpdate", function(status, game) {
    var template;

    switch (status) {
      case "createGame":
        var source   = $("#create-game-template").html();
        template = Handlebars.compile(source);
        break;
      case "registering": 
        var source = $("#registering-template").html();
        template = Handlebars.compile(source);
        break;
      case "registered": 
        var source   = $("#message-template").html();
        template = Handlebars.compile(source);
        var context =  { message: "Waiting for players. Please wait."};
        template = template(context);
        break;
      case "inprogress": 
        var source   = $("#message-template").html();
        template = Handlebars.compile(source);
        var context =  { message: "Game in progress. Please wait"};
        template = template(context);
        break;
      case "startGame":
        var source = $("#game-template").html();
        template = Handlebars.compile(source);

        var thead = '<th>Round</th>',
          trRound1 = '<td>1</td>',
          trTotal = '<td>Total</td>';

        game.players.forEach(function(player) {
          thead += '<th>' + player.name + '</th>';
          trRound1 += '<td></td>';
          trTotal += '<td>0</td>';
        });

        var context = {
          playerName: getPlayerNameText(game.players[0].name),
          total: 0,
          runningTotal: 0,
          thead: thead,
          trRound1: trRound1,
          trTotal: trTotal,
          disabled: game.players[0].name === name ? '' : 'disabled'
        }
        template = template(context);
        break;
    }
    $('.template-container').html(template);
    setClickHandlers();
  });

  function getPlayerNameText(currentPlayerName) {
    if (currentPlayerName === name) {
      return 'Your turn';
    }
    return currentPlayerName + "'s turn";
  }

  socket.on("rolled", rolled);

  function rolled(diceData) {
    setPlayedDiceOpacity();
    removeClickHandlers();

    $.when(animate.rollJustRolledDice(diceData.dice)).then(
      function() {
        showWin(diceData);
        $('.rollScore').text(diceData.turnScore);
        $('.totalTurnScore').text(diceData.totalTurnScore);
        if (diceData.turnScore === 0) {
          loseGo(diceData.currentPlayerName);
        } 
      });
  }

  function loseGo(currentPlayerName) {
    if (currentPlayerName === name) {
      $('.message').text('Unlucky!');
      setTimeout(function() {
        $('.message').text('');
        socket.emit('endGo');
      }, 2000);
    }    
  }

  function showWin(diceData) {
    var strWin = "";
    var strScore = "";
    var isCurrentPlayer = diceData.currentPlayerName === name;
    diceData.dice.forEach(function(die, i) {
      if (die.win && die.justRolled && (strWin.indexOf(die.win) === -1 || die.win === "1" || die.win === "5")) {
        strWin += die.win + ", ";
        strScore += " " + die.score;      
      }

      if (die.deselected && isCurrentPlayer) {
        $('#dice' + i).data('diceNumber', i);
        $('#dice' + i).data('selected', true);
        $('#dice' + i).on('click', updateScores);
      }

      if (die.win) {
        $('#dice' + i).css('-webkit-filter', 'sepia(1)');
        $('#dice' + i).data('diceNumber', i);
        $('#dice' + i).data('selected', false);
        if (isCurrentPlayer) {
          $('#dice' + i).on('click', updateScores);
        }        
      } else {
        $('#dice' + i).css('-webkit-filter', '');
      }
    });
    if (strWin !== "") {
      strWin = strWin.slice(0, -2);
    }
    $('.win').text(strWin);
    $('.score').text(strScore);
  }

  function updateScores() {
    var $dieEl = $(this);
    var selected = $dieEl.data('selected');
    var turnScore = parseInt($('.rollScore').text(), 10);
    socket.emit('updateScores', $dieEl.data('diceNumber'), turnScore, selected);
  }

  socket.on('updatedScores', updatedScores);

  function updatedScores(diceData) {
    removeClickHandlers();
    showWin(diceData);
    $('.rollScore').text(diceData.turnScore);
    $('.totalTurnScore').text(diceData.totalTurnScore);
  }

  function setPlayedDiceOpacity() {
    var count = 0;
    for(var i = 0; i < 6; i++) {
      var $dice = $('#dice' + i);
      if ($dice.css('opacity') === 0.5) {
        count++;
      }
      if ($dice.css('-webkit-filter') === "sepia(1)") {
        $dice.css('-webkit-filter', '');
        $dice.css('opacity', 0.5);
        count++;
      }
    }
    if (count === 6) {
      for(var i = 0; i < 6; i++) {
        var $dice = $('#dice' + i);
        $dice.css('opacity', '');
      }
    }
  }

  function removeClickHandlers() {
    for(var i = 0; i < 6; i++) {
      $('#dice' + i).off('click');
    }
  }

  function resetDiceCss() {
    for(var i = 0; i < 6; i++) {
      var $dice = $('#dice' + i);
      $dice.css('-webkit-filter', '');
      $dice.css('opacity', '');
    }
  }

  socket.on("nextPlayersTurn", nextPlayersTurn);

  function nextPlayersTurn(data) {
    updateScoreTable(data);

    if (data.winner) {
      $('.message').text(data.winner + " won!");
    } else {
      var playerNameText = getPlayerNameText(data.name);

      $('.player-name').text(playerNameText);
      if (name === data.name) {
        enableButtons();
      } else {
        disableButtons();
      }

      $('.totalTurnScore').text(0);
      $('.rollScore').text(0);
      $('.win').text('');
      $('.score').text('');

      resetDiceCss();
    }
  }

  function updateScoreTable(data) {
    var $scoreRow = $('table tr:last').prev();
    var $totalScoreRow = $('table tr:last');
    var columnNumber = data.prevPlayerNumber + 1;
    var $scoreCell = $scoreRow.find('td:nth-child(' + columnNumber  + ')');
    var $totalScoreCell = $totalScoreRow.find('td:nth-child(' + columnNumber  + ')');
    $scoreCell.text(data.prevPlayerTotalTurnScore);
    $totalScoreCell.text(data.prevPlayerTotalScore);

    if (data.endOfRound) {
      var newRow = '<tr><td>' + data.round + '</td>';
      for(var i = 0; i < data.numberOfPlayers; i++) {
        newRow += '<td></td>';
      }
      newRow += '</tr>';
      var $newRow = $(newRow);
      $scoreRow.after($newRow);
    }    
  }

  function enableButtons() {
    $('button').each(function() {
      $(this).prop("disabled", false)
    });
  }

  function disableButtons() {
    $('button').each(function() {
      $(this).prop("disabled", true)
    });
  }

  function setClickHandlers() {
    $('.create-button').on('click', function() {
      socket.emit("createGame", parseInt($('#players').val(), 10));
    });

    $('.join').on('click', function() {
      name = $('#name').val();
      var data = {
        name: $('#name').val(),
        id: createGuid()
      }
      socket.emit("register", data);
    });

    $('.roll').on('click', function() {
      socket.emit("roll");
    });

    $('.restartGame').on('click', function() {
      socket.emit('restartGame');
      location.reload();
    });

    $('.endGo').on('click', function() {
      socket.emit("endGo");
    });
  }

</script>
</body>
</html>